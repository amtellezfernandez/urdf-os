<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SO101 VLA Demo</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #111;
        color: #f5f5f5;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        padding: 0.75rem 1rem;
        background: #181818;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        font-size: 1.1rem;
        margin: 0;
      }
      #phase-indicator {
        font-size: 0.9rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        background: #333;
      }
      main {
        flex: 1;
        display: grid;
        grid-template-columns: 1.6fr 1fr;
        gap: 0.5rem;
        padding: 0.5rem;
        min-height: 0;
      }
      section {
        background: #181818;
        border-radius: 6px;
        border: 1px solid #333;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      section h2 {
        font-size: 0.95rem;
        margin: 0;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid #333;
      }
      #video-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
        padding: 0.5rem;
      }
      #camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        width: 100%;
        height: 100%;
      }
      .camera-panel {
        display: flex;
        flex-direction: column;
        background: #222;
        border-radius: 4px;
        overflow: hidden;
      }
      .camera-label {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: #9aa0a6;
        border-bottom: 1px solid #333;
        text-transform: capitalize;
      }
      .camera-feed {
        width: 100%;
        height: auto;
        object-fit: contain;
        background: #000;
      }
      #video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      #controls {
        padding: 0.5rem 0.75rem;
        border-top: 1px solid #333;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }
      button {
        background: #2d6cdf;
        border: none;
        color: #fff;
        padding: 0.25rem 0.7rem;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
      }
      button.secondary {
        background: #333;
      }
      button:disabled {
        background: #333;
        cursor: default;
        opacity: 0.7;
      }
      #status-bar {
        font-size: 0.8rem;
        padding: 0.3rem 0.75rem;
        border-top: 1px solid #333;
        background: #141414;
      }
      #chat-log,
      #reasoning-log {
        flex: 1;
        padding: 0.5rem 0.75rem;
        overflow-y: auto;
        font-size: 0.85rem;
      }
      .log-entry {
        margin-bottom: 0.35rem;
      }
      .log-entry span.role {
        font-weight: 600;
        margin-right: 0.35rem;
      }
      .log-entry.system {
        color: #9aa0a6;
      }
      .log-entry.assistant {
        color: #a5d6ff;
      }
      .log-entry.user {
        color: #e8eaed;
      }
      #chat-input-row {
        display: flex;
        padding: 0.4rem 0.75rem 0.6rem;
        gap: 0.4rem;
        border-top: 1px solid #333;
      }
      #chat-input {
        flex: 1;
        background: #111;
        border-radius: 4px;
        border: 1px solid #333;
        padding: 0.25rem 0.5rem;
        color: inherit;
        font-size: 0.85rem;
      }
      #chat-input:focus {
        outline: none;
        border-color: #2d6cdf;
      }
      #right-column {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-height: 0;
      }
      #teleop-section {
        flex: 1;
      }
      #teleop-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.35rem 0.5rem;
        padding: 0.6rem 0.75rem 0.4rem;
        font-size: 0.85rem;
      }
      #teleop-form label {
        display: block;
        margin-bottom: 0.15rem;
        color: #c6cbd3;
      }
      #teleop-form select,
      #teleop-form input {
        width: 100%;
        background: #111;
        border: 1px solid #333;
        border-radius: 4px;
        color: #f5f5f5;
        padding: 0.35rem 0.45rem;
      }
      #teleop-form input:focus,
      #teleop-form select:focus {
        outline: none;
        border-color: #2d6cdf;
      }
      #teleop-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.2rem 0.75rem 0.65rem;
        border-top: 1px solid #333;
      }
      #teleop-status {
        font-size: 0.85rem;
        color: #c6cbd3;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
        margin-top: 0.35rem;
      }
      th,
      td {
        text-align: left;
        padding: 0.25rem 0.4rem;
      }
      th {
        color: #c6cbd3;
        font-weight: 600;
        border-bottom: 1px solid #333;
      }
      td {
        border-bottom: 1px solid #222;
      }
      .muted {
        color: #9aa0a6;
      }
      footer {
        padding: 0.3rem 0.75rem;
        font-size: 0.75rem;
        border-top: 1px solid #333;
        background: #141414;
        color: #9aa0a6;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>SO101 VLA Demo</h1>
      <div style="display: flex; gap: 1.5rem; align-items: center;">
        <div id="teleop-header-config" style="font-size: 0.9rem; color: #9aa0a6; line-height: 1.4;">
          <div>Leader: <span id="header-leader" style="color: #f5f5f5;">--</span></div>
          <div>Follower: <span id="header-follower" style="color: #f5f5f5;">--</span></div>
          <div>Cameras: <span id="header-cameras" style="color: #f5f5f5;">--</span></div>
        </div>
        <div id="phase-indicator">Idle</div>
      </div>
    </header>

    <main>
      <section id="video-section">
        <h2>Cameras</h2>
        <div id="video-container">
          <div id="camera-grid">
            <!-- Camera panels will be dynamically created -->
          </div>
        </div>
        <div id="controls">
          <button id="connect-btn">Connect</button>
          <button id="disconnect-btn" disabled>Disconnect</button>
        </div>
        <div id="status-bar">
          Status: <span id="status-text">Disconnected</span>
        </div>
      </section>

      <div id="right-column">
        <section id="chat-section">
          <h2>Chat & Reasoning</h2>
          <div id="chat-log"></div>
          <div id="reasoning-log"></div>
          <div id="chat-input-row">
            <input
              id="chat-input"
              type="text"
              placeholder="Chat (try: /stream on, /stream off, /help)"
            />
            <button id="send-chat-btn" disabled>Send</button>
          </div>
        </section>

        <section id="teleop-section">
          <h2>Teleop Control</h2>
          <div id="teleop-actions">
            <button id="start-teleop-btn">Start Teleop</button>
            <button id="stop-teleop-btn" class="secondary" disabled>
              Stop Teleop
            </button>
            <div id="teleop-status" class="muted">Idle</div>
          </div>
          <div id="eval-actions" style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #333;">
            <div style="margin-bottom: 0.5rem;"><strong>Eval VLA</strong></div>
            <button id="start-eval-btn">Start Eval</button>
            <button id="start-eval2-btn">Start Eval 2</button>
            <button id="stop-eval-btn" class="secondary" disabled>
              Stop Eval
            </button>
            <div id="eval-status" class="muted">Idle</div>
          </div>
          <div id="robot-actions" style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #333;">
            <div style="margin-bottom: 0.5rem;"><strong>Emergency</strong></div>
            <button id="release-robot-btn" style="background: #8b0000; border-color: #a00;">
              Release Robot
            </button>
            <div class="muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Kills eval, disables torque</div>
          </div>
        </section>
      </div>
    </main>

    <footer>
      SO101 VLA Demo (VLM stubbed by default). Use <code>USE_MOCK_ROBOT=true</code> for mock mode.
    </footer>

    <script>
      let ws = null;
      let isConnected = false;
      const connectBtn = document.getElementById("connect-btn");
      const disconnectBtn = document.getElementById("disconnect-btn");
      const sendChatBtn = document.getElementById("send-chat-btn");
      const chatInput = document.getElementById("chat-input");
      const cameraGrid = document.getElementById("camera-grid");
      const chatLog = document.getElementById("chat-log");

      // Track known cameras for dynamic panel creation
      const knownCameras = new Set();
      const reasoningLog = document.getElementById("reasoning-log");
      const statusText = document.getElementById("status-text");
      const phaseIndicator = document.getElementById("phase-indicator");
      const startTeleopBtn = document.getElementById("start-teleop-btn");
      const stopTeleopBtn = document.getElementById("stop-teleop-btn");
      const startEvalBtn = document.getElementById("start-eval-btn");
      const startEval2Btn = document.getElementById("start-eval2-btn");
      const stopEvalBtn = document.getElementById("stop-eval-btn");
      const evalStatusEl = document.getElementById("eval-status");
      const teleopStatusEl = document.getElementById("teleop-status");
      const headerLeader = document.getElementById("header-leader");
      const headerFollower = document.getElementById("header-follower");
      const headerCameras = document.getElementById("header-cameras");

      function setPhase(phase) {
        phaseIndicator.textContent = phase || "Idle";
      }

      function appendChat(role, text) {
        const div = document.createElement("div");
        div.classList.add("log-entry", role);
        const roleSpan = document.createElement("span");
        roleSpan.classList.add("role");
        roleSpan.textContent = role === "assistant" ? "Assistant" : "User";
        const textSpan = document.createElement("span");
        textSpan.textContent = text;
        div.appendChild(roleSpan);
        div.appendChild(textSpan);
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function appendReasoning(text) {
        const div = document.createElement("div");
        div.classList.add("log-entry", "system");
        div.textContent = text;
        reasoningLog.appendChild(div);
        reasoningLog.scrollTop = reasoningLog.scrollHeight;
      }

      function setConnectedUi(connected) {
        isConnected = connected;
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
        sendChatBtn.disabled = !connected;
        chatInput.disabled = !connected;
        statusText.textContent = connected ? "Connected" : "Disconnected";
        if (!connected) {
          setPhase("Idle");
        }
      }

      async function refreshDeviceConfig() {
        // Deprecated: device table removed from UI.
      }


      async function updateTeleopStatus() {
        try {
          const res = await fetch("/api/teleop/status");
          const data = await res.json();
          const running = data.running;
          const available = data.teleop_available !== false;
          if (!available) {
            const reason = data.teleop_unavailable_reason || "leader not configured";
            teleopStatusEl.textContent = `Unavailable (${reason})`;
            startTeleopBtn.disabled = true;
            stopTeleopBtn.disabled = true;
            return;
          }
          teleopStatusEl.textContent = running
            ? `Running (pid ${data.pid || "?"})`
            : "Idle";
          startTeleopBtn.disabled = running;
          stopTeleopBtn.disabled = !running;
        } catch {
          teleopStatusEl.textContent = "Idle";
        }
      }

      async function updateEvalStatus() {
        try {
          const res = await fetch("/api/eval_vla/status");
          const data = await res.json();
          const running = data.running;
          evalStatusEl.textContent = running ? "Running" : "Idle";
          startEvalBtn.disabled = running;
          startEval2Btn.disabled = running;
          stopEvalBtn.disabled = !running;
        } catch {
          evalStatusEl.textContent = "Idle";
          startEvalBtn.disabled = false;
          startEval2Btn.disabled = false;
          stopEvalBtn.disabled = true;
        }
      }

      async function refreshTeleopDefaults() {
        try {
          const res = await fetch("/api/teleop/defaults");
          const data = await res.json();
          const available = data.teleop_available !== false;
          if (!available) {
            startTeleopBtn.disabled = true;
            stopTeleopBtn.disabled = true;
            teleopStatusEl.textContent = "Unavailable (leader not configured)";
          }
          const leader = `${data.teleop_id || "(unset)"} @ ${
            data.teleop_port || "(unset)"
          }`;
          const follower = `${data.robot_id || "(unset)"} @ ${
            data.robot_port || "(unset)"
          }`;
          headerLeader.textContent = leader;
          headerFollower.textContent = follower;
          headerCameras.textContent = data.cameras || "(none)";
        } catch (err) {
          console.error(err);
          headerLeader.textContent = "(error)";
          headerFollower.textContent = "(error)";
          headerCameras.textContent = "(error)";
        }
      }

      async function startTeleop() {
        try {
          const res = await fetch("/api/teleop/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              display_data: true,
            }),
          });
          if (!res.ok) {
            const err = await res.json();
            appendReasoning(`Teleop start failed: ${err.detail || res.status}`);
          } else {
            appendReasoning("Teleop loop launched.");
          }
        } catch (err) {
          console.error(err);
          appendReasoning("Failed to start teleop loop.");
        }
        await updateTeleopStatus();
      }

      async function stopTeleop() {
        try {
          await fetch("/api/teleop/stop", { method: "POST" });
          appendReasoning("Teleop loop stopped.");
        } catch (err) {
          console.error(err);
          appendReasoning("Failed to stop teleop loop.");
        }
        await updateTeleopStatus();
      }

      async function startEval() {
        try {
          const res = await fetch("/api/eval_vla/start", { method: "POST" });
          if (!res.ok) {
            const err = await res.json();
            appendReasoning(`Eval start failed: ${err.detail || res.status}`);
          } else {
            appendReasoning("Eval VLA launched.");
          }
        } catch (err) {
          console.error(err);
          appendReasoning("Failed to start Eval VLA.");
        }
        await updateEvalStatus();
      }

      async function startEval2() {
        try {
          const res = await fetch("/api/eval_vla/start2", { method: "POST" });
          if (!res.ok) {
            const err = await res.json();
            appendReasoning(`Eval2 start failed: ${err.detail || res.status}`);
          } else {
            appendReasoning("Eval VLA 2 launched.");
          }
        } catch (err) {
          console.error(err);
          appendReasoning("Failed to start Eval VLA 2.");
        }
        await updateEvalStatus();
      }

      async function stopEval() {
        try {
          await fetch("/api/eval_vla/stop", { method: "POST" });
          appendReasoning("Eval VLA stopped.");
        } catch (err) {
          console.error(err);
          appendReasoning("Failed to stop Eval VLA.");
        }
        await updateEvalStatus();
      }

      async function releaseRobot() {
        appendReasoning("Releasing robot (killing processes, disabling torque)...");
        try {
          const res = await fetch("/api/robot/release", { method: "POST" });
          const data = await res.json();
          if (data.ok) {
            appendReasoning("Robot released: " + data.actions.join(", "));
            evalStatusEl.textContent = "Idle";
          } else {
            appendReasoning("Release failed: " + JSON.stringify(data));
          }
        } catch (err) {
          console.error(err);
          appendReasoning("Failed to release robot: " + err.message);
        }
        await updateEvalStatus();
      }

      function connectWs() {
        if (ws && isConnected) return;
        const proto = window.location.protocol === "https:" ? "wss" : "ws";
        const url = `${proto}://${window.location.host}/ws`;
        ws = new WebSocket(url);

        ws.onopen = () => {
          setConnectedUi(true);
          appendReasoning("WebSocket connected.");
          // Convenience: start streaming immediately so cameras are visible.
          sendJson({ type: "command", action: "start_stream" });
        };

        ws.onclose = () => {
          setConnectedUi(false);
          appendReasoning("WebSocket disconnected.");
        };

        ws.onerror = (ev) => {
          console.error("WebSocket error", ev);
        };

        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            handleMessage(data);
          } catch {
            console.warn("Non-JSON message from server:", ev.data);
          }
        };
      }

      function ensureCameraPanel(camName) {
        if (knownCameras.has(camName)) {
          return document.getElementById(`video-${camName}`);
        }
        // Create new camera panel
        const panel = document.createElement("div");
        panel.classList.add("camera-panel");
        panel.id = `panel-${camName}`;

        const label = document.createElement("div");
        label.classList.add("camera-label");
        label.textContent = camName;

        const img = document.createElement("img");
        img.classList.add("camera-feed");
        img.id = `video-${camName}`;
        img.alt = `${camName} camera`;

        panel.appendChild(label);
        panel.appendChild(img);
        cameraGrid.appendChild(panel);
        knownCameras.add(camName);
        return img;
      }

      function handleMessage(msg) {
        const type = msg.type;
        if (type === "frame") {
          // Handle multi-camera frames
          if (msg.cameras) {
            for (const [camName, camData] of Object.entries(msg.cameras)) {
              const imgEl = ensureCameraPanel(camName);
              if (imgEl && camData.image_b64) {
                imgEl.src = `data:image/jpeg;base64,${camData.image_b64}`;
              }
            }
          }
          // Backward compatibility: single image_b64
          if (msg.image_b64 && !msg.cameras) {
            const imgEl = ensureCameraPanel("wrist");
            if (imgEl) {
              imgEl.src = `data:image/jpeg;base64,${msg.image_b64}`;
            }
          }
        } else if (type === "chat") {
          appendChat("assistant", msg.text || "");
        } else if (type === "status") {
          if (msg.phase) {
            setPhase(
              msg.phase.charAt(0).toUpperCase() + msg.phase.slice(1)
            );
          }
          if (msg.text) {
            appendReasoning(`[status] ${msg.text}`);
          }
        } else if (type === "reasoning") {
          if (msg.thought) {
            appendReasoning(msg.thought);
          }
        } else if (type === "error") {
          appendReasoning(`[error] ${msg.text || "Unknown error"}`);
        }
      }

      function sendJson(obj) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendReasoning("Cannot send message: WebSocket not open.");
          return;
        }
        ws.send(JSON.stringify(obj));
      }

      connectBtn.addEventListener("click", () => {
        connectWs();
      });

      disconnectBtn.addEventListener("click", () => {
        if (ws) {
          ws.close();
        }
      });

      sendChatBtn.addEventListener("click", () => {
        const text = chatInput.value.trim();
        if (!text) return;
        appendChat("user", text);
        chatInput.value = "";
        sendJson({ type: "chat", text });
      });

      chatInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          sendChatBtn.click();
        }
      });

      startTeleopBtn.addEventListener("click", startTeleop);
      stopTeleopBtn.addEventListener("click", stopTeleop);
      startEvalBtn.addEventListener("click", startEval);
      startEval2Btn.addEventListener("click", startEval2);
      stopEvalBtn.addEventListener("click", stopEval);
      document.getElementById("release-robot-btn").addEventListener("click", releaseRobot);

      refreshDeviceConfig();
      refreshTeleopDefaults();
      updateTeleopStatus();
      updateEvalStatus();
      setInterval(updateTeleopStatus, 4000);
    </script>
  </body>
</html>
